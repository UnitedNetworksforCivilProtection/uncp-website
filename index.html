<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>United Networks for Civil Protection (UNCP)</title>
<link rel="icon" href="logo.jpeg">
<!-- jsPDF for PDF generation -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<!-- EmailJS SDK -->
<script src="https://cdn.emailjs.com/sdk/3.2/email.min.js"></script>
<style>
  /* Minimal styling ‚Äî keep as before or swap to your styles.css */
  body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f4f6f9;color:#222}
  .container{max-width:1100px;margin:18px auto;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between;padding:12px;background:#fff;border-bottom:1px solid #e6eefc;position:sticky;top:0;z-index:1000}
  .brand{display:flex;align-items:center;gap:12px}
  .brand img{height:80px}
  nav ul{display:flex;gap:12px;list-style:none;margin:0;padding:0;align-items:center}
  nav li{position:relative}
  nav a{color:#0b3b66;font-weight:700;padding:8px;border-radius:6px}
  .donate{background:#ff7f00;color:#fff;padding:8px 12px;border-radius:8px}
  section{background:#fff;margin:18px 0;padding:18px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
  h1,h2{color:#083e6b}
  .accordion{margin-top:12px}
  .accordion-item{border:1px solid #e6eefc;border-radius:8px;margin-bottom:10px;overflow:hidden}
  .accordion-header{background:#f7fbff;padding:12px;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
  .accordion-body{max-height:0;overflow:hidden;transition:max-height .28s ease;padding:0 12px}
  .accordion-item.active .accordion-body{padding:12px}
  form label{display:block;margin-top:10px;font-weight:700}
  input,select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #d6d6d6;margin-top:6px}
  .btn{background:#0b62a6;color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;margin-top:12px}
  .btn.secondary{background:#eef4ff;color:#0b62a6}
  .inline{display:flex;gap:12px}
  .chip{display:inline-block;padding:6px 10px;border-radius:999px;border:1px dashed #0b62a6;margin:4px}
</style>
</head>
<body>

<div class="container">

  <!-- Header -->
  <header>
    <div class="brand">
      <a href="#home"><img src="logo.jpeg" alt="UNCP Logo"></a>
      <div>
        <div style="font-weight:900;color:#083e6b">United Networks for Civil Protection</div>
        <div style="font-size:13px;color:#666">Community-Based Non-Profit ‚Ä¢ Company Limited by Guarantee (Uganda)</div>
      </div>
    </div>

    <nav>
      <ul>
        <li><a href="#home">Home</a></li>
        <li><a href="#about">About</a></li>
        <li><a href="#what-we-do">What We Do</a></li>
        <li><a href="#where-we-work">Where We Work</a></li>
        <li><a href="#careersSection">Careers</a></li>
        <li><a href="#donate" class="donate">Donate</a></li>
        <li style="position:relative"><button id="searchToggle" title="Search" style="background:none;border:none;font-size:18px;cursor:pointer">üîç</button>
          <div id="searchPanel" style="display:none;position:absolute;right:0;top:36px;background:#fff;padding:8px;border-radius:6px;border:1px solid #e6eefc;">
            <input id="globalSearch" placeholder="Search jobs & site" style="width:220px;padding:6px;border:1px solid #ddd;border-radius:6px">
          </div>
        </li>
      </ul>
    </nav>
  </header>

  <!-- Home -->
  <section id="home">
    <h1>United Networks for Civil Protection (UNCP)</h1>
    <p><strong>Type:</strong> Community-Based Organization</p>
    <p><strong>Incorporated:</strong> Company Limited by Guarantee, Uganda</p>
    <p class="muted">We protect and empower vulnerable children, youth and communities in refugee & host settings.</p>
  </section>

  <!-- Accordion: About / What we do / Where we work -->
  <section id="about" class="accordion">
    <!-- About -->
    <div class="accordion-item" id="accordion-about">
      <div class="accordion-header">About UNCP <span>+</span></div>
      <div class="accordion-body">
        <h3>Overview</h3>
        <p>United Networks for Civil Protection (UNCP) ... (short overview)</p>
        <h4>History</h4>
        <p>Founded in 2018 by child protection specialists...</p>
        <h4>Mission & Vision</h4>
        <p>Mission: ... Vision: ...</p>
      </div>
    </div>

    <!-- What we do -->
    <div class="accordion-item" id="accordion-what">
      <div class="accordion-header">What We Do <span>+</span></div>
      <div class="accordion-body">
        <ul>
          <li>Child Protection</li>
          <li>GBV Prevention</li>
          <li>MHPSS</li>
          <li>Youth Empowerment</li>
          <li>Climate & Livelihoods</li>
          <li>Inclusive Education</li>
        </ul>
      </div>
    </div>

    <!-- Where we work -->
    <div class="accordion-item" id="accordion-where">
      <div class="accordion-header">Where We Work <span>+</span></div>
      <div class="accordion-body">
        <p class="muted">Uganda ‚Äî districts we work in:</p>
        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px">
          <span class="chip">Arua City</span><span class="chip">Arua District</span><span class="chip">Madi Okollo</span>
          <span class="chip">Terego</span><span class="chip">Adjumani</span><span class="chip">Moyo</span><span class="chip">Obongi</span>
          <span class="chip">Pakwach</span><span class="chip">Nebbi</span><span class="chip">Koboko</span><span class="chip">Yumbe</span>
          <span class="chip">Zombo</span><span class="chip">Maracha</span>
        </div>
      </div>
    </div>

  </section>

  <!-- Open positions (template blocks) -->
  <section id="careersSection">
    <h2>Open Positions</h2>
    <input id="jobSearch" placeholder="Filter positions (keyword)..." style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin-bottom:12px">

    <div id="jobList">
      <!-- Template for a job (copy/paste this block to add jobs) -->
      <div class="job card" data-deadline="2025-09-24" style="padding:12px;margin-bottom:12px;border-left:4px solid #083e6b;">
        <strong>Child Protection Case Worker (Volunteer)</strong>
        <div style="margin-top:6px;color:#444">Arua City ‚Ä¢ 6 months ‚Ä¢ Application: 10 Sep 2025 ‚Äì 24 Sep 2025</div>
        <div style="margin-top:8px">
          <button class="btn" onclick="showJD('Child Protection Case Worker (Volunteer)')">View JD</button>
          <button class="btn" onclick="startApplication('Child Protection Case Worker (Volunteer)','2025-09-24')">Apply</button>
        </div>
      </div>
      <!-- end template -->
    </div>
  </section>

  <!-- Job Description modal (simple) -->
  <div id="jdModal" style="display:none;position:fixed;left:50%;top:6%;transform:translateX(-50%);max-width:900px;width:92%;background:#fff;padding:16px;border-radius:10px;box-shadow:0 20px 60px rgba(0,0,0,.25);z-index:3000;">
    <div id="jdContent"></div>
    <div style="text-align:right;margin-top:12px"><button onclick="closeJD()" class="btn secondary">Close</button></div>
  </div>

  <!-- Full multi-step application form -->
  <section id="application" class="card" style="padding:16px">
    <h2>Application Form</h2>
    <form id="careersForm">

      <input type="hidden" name="position_title" id="position_title" value="">

      <!-- Step 1: Personal Info -->
      <div class="form-step" data-step="1">
        <h3>Step 1 ‚Äî Personal Information</h3>

        <label>How Did You Hear About Us? <span class="required">*</span></label>
        <select name="how_hear" required>
          <option value="">--Select--</option>
          <option>Job Board</option><option>Event</option><option>Social Media</option><option>UNCP Website</option><option>Other</option>
        </select>

        <label>Have you previously worked for UNCP? <span class="required">*</span></label>
        <div class="inline">
          <label><input type="radio" name="worked_uncp" value="Yes" required> Yes</label>
          <label><input type="radio" name="worked_uncp" value="No" required> No</label>
        </div>

        <label>Full Name <span class="required">*</span></label><input type="text" name="candidate_name" required>
        <label>Address</label><input type="text" name="candidate_address">
        <label>Email <span class="required">*</span></label><input type="email" name="candidate_email" required>
        <label>Phone <span class="required">*</span></label><input type="tel" name="candidate_phone" required>

        <div class="btn-group" style="margin-top:14px">
          <button type="button" class="btn secondary" onclick="saveDraft()">Save Draft</button>
          <button type="button" class="btn" onclick="goToStep(2)">Next</button>
        </div>
      </div>

      <!-- Step 2: Work Experience (repeatable up to 4) -->
      <div class="form-step" data-step="2">
        <h3>Step 2 ‚Äî Work Experience</h3>
        <p class="hint">List up to 4 work experiences. Use "Add more" to include more.</p>
        <div id="workExpWrap">
          <div class="workExp card" data-index="1" style="padding:12px;margin-bottom:10px">
            <label>Job Title *</label><input type="text" name="job_title_1" required>
            <label>Company *</label><input type="text" name="company_1" required>
            <label>Location</label><input type="text" name="location_1">
            <label><input type="checkbox" name="current_1"> I currently work here</label>
            <div class="inline">
              <div><label>From</label><input type="date" name="from_1"></div>
              <div><label>To</label><input type="date" name="to_1"></div>
            </div>
            <label>Role Description (max 1500 chars)</label><textarea name="role_desc_1" maxlength="1500"></textarea>
          </div>
        </div>
        <button type="button" class="btn secondary" onclick="addWorkExp()">Add More</button>

        <div class="btn-group"><button type="button" class="btn secondary" onclick="goToStep(1)">Back</button><button type="button" class="btn" onclick="goToStep(3)">Next</button></div>
      </div>

      <!-- Step 3: Education -->
      <div class="form-step" data-step="3">
        <h3>Step 3 ‚Äî Education</h3>
        <div id="eduWrap">
          <div class="edu card" data-index="1" style="padding:12px;margin-bottom:10px">
            <label>School / University *</label><input type="text" name="school_1" required>
            <label>Degree *</label><input type="text" name="degree_1" required>
            <label>Field of Study</label><input type="text" name="field_1">
            <div class="inline"><div><label>From</label><input type="date" name="edu_from_1"></div><div><label>To</label><input type="date" name="edu_to_1"></div></div>
          </div>
        </div>
        <button type="button" class="btn secondary" onclick="addEdu()">Add More</button>
        <div class="btn-group"><button type="button" class="btn secondary" onclick="goToStep(2)">Back</button><button type="button" class="btn" onclick="goToStep(4)">Next</button></div>
      </div>

      <!-- Step 4: Certifications -->
      <div class="form-step" data-step="4">
        <h3>Step 4 ‚Äî Certifications (Optional)</h3>
        <div id="certWrap">
          <div class="cert card" data-index="1" style="padding:12px;margin-bottom:10px">
            <label>Certification Name</label><input type="text" name="cert_name_1">
            <label>Certification Number</label><input type="text" name="cert_no_1">
            <label>Issued Date</label><input type="date" name="cert_date_1">
            <label>Attachment (file)</label><input type="file" name="cert_file_1">
          </div>
        </div>
        <button type="button" class="btn secondary" onclick="addCert()">Add More</button>
        <div class="btn-group"><button type="button" class="btn secondary" onclick="goToStep(3)">Back</button><button type="button" class="btn" onclick="goToStep(5)">Next</button></div>
      </div>

      <!-- Step 5: Languages & Skills -->
      <div class="form-step" data-step="5">
        <h3>Step 5 ‚Äî Languages & Skills</h3>
        <div id="langWrap">
          <div class="lang card" data-index="1" style="padding:12px;margin-bottom:10px">
            <label>Language *</label>
            <select name="lang_1" required>
              <option value="">--Select--</option><option>Lugbarati</option><option>Alur</option><option>Kakwa</option><option>Ma‚Äôdi</option><option>Luganda</option><option>English</option><option>Other</option>
            </select>
            <label><input type="checkbox" name="fluent_1"> I am fluent</label>
            <label>Overall (A1‚ÄìC2 / Mother Tongue) *</label>
            <select name="level_1" required><option value="">--Select--</option><option>A1</option><option>A2</option><option>B1</option><option>B2</option><option>C1</option><option>C2</option><option>Mother Tongue</option></select>
          </div>
        </div>
        <button type="button" class="btn secondary" onclick="addLang()">Add More</button>

        <label>Skills (max 1500 chars)</label><textarea name="skills" maxlength="1500"></textarea>

        <div class="btn-group"><button type="button" class="btn secondary" onclick="goToStep(4)">Back</button><button type="button" class="btn" onclick="goToStep(6)">Next</button></div>
      </div>

      <!-- Step 6: Application Questions -->
      <div class="form-step" data-step="6">
        <h3>Step 6 ‚Äî Application Questions</h3>
        <label>a) How have your achievements and operational experience prepared you for this position? (2500 chars) *</label>
        <textarea name="q1" maxlength="2500" required></textarea>

        <label>b) Describe skills & competencies relevant to this position (2500 chars) *</label>
        <textarea name="q2" maxlength="2500" required></textarea>

        <label>c) How does this position align with your career aspirations? (1000 chars) *</label>
        <textarea name="q3" maxlength="1000" required></textarea>

        <div class="btn-group"><button type="button" class="btn secondary" onclick="goToStep(5)">Back</button><button type="button" class="btn" onclick="goToStep(7)">Next</button></div>
      </div>

      <!-- Step 7: References -->
      <div class="form-step" data-step="7">
        <h3>Step 7 ‚Äî References</h3>
        <div id="refsWrap">
          <div class="ref card" data-index="1" style="padding:12px;margin-bottom:10px">
            <label>Reference Name *</label><input type="text" name="ref_name_1" required>
            <label>Organization / Address *</label><input type="text" name="ref_org_1" required>
            <label>Position *</label><input type="text" name="ref_position_1" required>
            <label>Relationship with Candidate *</label><input type="text" name="ref_relationship_1" required>
            <label>Email *</label><input type="email" name="ref_email_1" required>
            <label>Telephone *</label><input type="tel" name="ref_phone_1" required>
            <label>Notes</label><textarea name="ref_notes_1"></textarea>
          </div>
        </div>
        <button type="button" class="btn secondary" onclick="addRef()">Add More Reference</button>
        <div class="btn-group"><button type="button" class="btn secondary" onclick="goToStep(6)">Back</button><button type="button" class="btn" onclick="goToStep(8)">Next</button></div>
      </div>

      <!-- Step 8: Voluntary Disclosures & Terms -->
      <div class="form-step" data-step="8">
        <h3>Step 8 ‚Äî Voluntary Disclosures & Terms</h3>
        <label>Date of Birth *</label><input type="date" name="dob" required>
        <label>Marital Status *</label>
        <select name="marital" required><option value="">--Select--</option><option>Single</option><option>Married</option><option>Separated</option><option>Divorced</option><option>Registered partnership</option><option>Other</option></select>

        <label>Disability</label><select name="disability"><option>No</option><option>Yes</option></select>

        <label>Sex *</label><select name="sex" required><option value="">--Select--</option><option>Female</option><option>Male</option><option>Not declared</option></select>

        <div style="margin-top:12px;padding:12px;border:1px solid #e6eefc;border-radius:8px">
          <p><strong>Terms</strong>: UNCP will only contact shortlisted candidates. UNCP processes personal data as per its Privacy Policy. We may verify education and employment. False information may lead to disqualification.</p>
          <label><input type="checkbox" name="agree_terms" id="agree_terms" required> I acknowledge and agree to these terms *</label>
        </div>

        <div class="btn-group"><button type="button" class="btn secondary" onclick="goToStep(7)">Back</button><button type="button" class="btn" onclick="reviewAndSubmit()">Review & Submit</button></div>
      </div>

    </form>
  </section>

  <!-- Submit confirmation area -->
  <section id="submitInfo" style="display:none" class="card">
    <h2>Submitting...</h2>
    <p id="submitStatus">Please wait while we process your application. You will receive a confirmation email shortly.</p>
  </section>

  <!-- Donate / Contact / Legal -->
  <section id="donate" class="card">
    <h2>Donate / Contact</h2>
    <p>Email: <a href="mailto:uncip2019@gmail.com">uncip2019@gmail.com</a></p>
    <p>Tel: +256 702 398687 / +256 779 576538</p>
  </section>

  <!-- Footer -->
  <footer style="margin-top:18px">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
      <div><img src="logo.jpeg" alt="UNCP" style="height:56px"></div>
      <div>
        <p><strong>Contact</strong></p>
        <p>Email: <a href="mailto:uncip2019@gmail.com">uncip2019@gmail.com</a><br>Tel: +256 702 398687 / +256 779 576538</p>
      </div>
      <div>
        <p><strong>Follow</strong></p>
        <div style="display:flex;gap:8px"><a href="#">F</a><a href="#">X</a><a href="#">I</a><a href="#">Y</a></div>
      </div>
    </div>
  </footer>

</div> <!-- /container -->

<!-- ===========================
     Replace the placeholders below:
     - YOUR_EMAILJS_USER_ID
     - YOUR_EMAILJS_SERVICE_ID
     - YOUR_EMAILJS_TEMPLATE_UNCP
     - YOUR_EMAILJS_TEMPLATE_CANDIDATE
     - APPS_SCRIPT_URL
     - APPS_SCRIPT_TOKEN
     =========================== -->

<script>
/* ====== Config - REPLACE THESE ====== */
const EMAILJS_USER_ID = "YOUR_EMAILJS_USER_ID";
const EMAILJS_SERVICE_ID = "YOUR_EMAILJS_SERVICE_ID";
const EMAILJS_TEMPLATE_UNCP = "YOUR_EMAILJS_TEMPLATE_UNCP"; // sends full application to UNCP
const EMAILJS_TEMPLATE_CANDIDATE = "YOUR_EMAILJS_TEMPLATE_CANDIDATE"; // sends confirmation to candidate
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/REPLACE_WITH_YOUR_DEPLOYED_URL/exec";
const APPS_SCRIPT_TOKEN = "REPLACE_WITH_YOUR_SCRIPT_TOKEN";
/* ==================================== */

emailjs.init(EMAILJS_USER_ID);

/* ========== Accordion (FAQ-style, multiple open) ========== */
document.querySelectorAll('.accordion-item .accordion-header').forEach(h=>{
  h.addEventListener('click', ()=>{
    const item = h.parentElement;
    item.classList.toggle('active');
    const body = item.querySelector('.accordion-body');
    if(item.classList.contains('active')) {
      body.style.maxHeight = body.scrollHeight + 'px';
      h.querySelector('span').innerText = '‚àí';
    } else {
      body.style.maxHeight = null;
      h.querySelector('span').innerText = '+';
    }
  });
});

/* ========== Search Toggle ========== */
document.getElementById('searchToggle').addEventListener('click', ()=>{
  const p = document.getElementById('searchPanel');
  p.style.display = p.style.display === 'block' ? 'none' : 'block';
});

/* ========== Jobs auto-hide by deadline and search filter ========== */
(function initJobs(){
  // hide expired jobs
  const today = new Date();
  document.querySelectorAll('#jobList .job').forEach(job=>{
    const d = job.dataset.deadline;
    if(d && new Date(d + 'T23:59:59') < today) job.style.display = 'none';
  });

  // filtering
  const jobSearch = document.getElementById('jobSearch');
  jobSearch.addEventListener('input', ()=>{
    const q = jobSearch.value.toLowerCase();
    document.querySelectorAll('#jobList .job').forEach(job=>{
      const title = job.querySelector('strong').innerText.toLowerCase();
      job.style.display = title.includes(q) ? '' : 'none';
    });
  });
})();

/* ========== JD modal helpers ========== */
const jobDescriptions = {
  "Child Protection Case Worker (Volunteer)": `<h3>Child Protection Case Worker (Volunteer)</h3>
    <p>Purpose: Provide direct support to children at risk, case management, PSS and community engagement.</p>
    <h4>Responsibilities</h4><ul><li>Case intake & management</li><li>PSS and referrals</li><li>Community awareness</li></ul>
    <h4>Qualifications</h4><p>Degree/diploma in Social Work, Psychology or related field; prior experience advantageous.</p>`
};
function showJD(title){
  document.getElementById('jdContent').innerHTML = jobDescriptions[title] || '<p>Job description not found.</p>';
  document.getElementById('jdModal').style.display = 'block';
}
function closeJD(){ document.getElementById('jdModal').style.display = 'none'; }

/* ========== Multi-step form helpers ========== */
const form = document.getElementById('careersForm');
let currentStep = 1;
const totalSteps = 8;

function goToStep(n){
  if(n < 1 || n > totalSteps) return;
  // hide all, show target
  document.querySelectorAll('.form-step').forEach(el=>el.style.display='none');
  const show = document.querySelector('.form-step[data-step="'+n+'"]');
  if(show) show.style.display = 'block';
  currentStep = n;
}
// init show step 1
goToStep(1);

/* dynamic add functions */
let workCount = 1, eduCount = 1, certCount = 1, langCount = 1, refCount = 1;

function addWorkExp(){
  workCount++; if(workCount>8){ alert('Maximum entries reached'); return; }
  const wrap = document.getElementById('workExpWrap');
  const div = document.createElement('div'); div.className='workExp card'; div.dataset.index = workCount; div.style.padding='12px'; div.style.marginBottom='10px';
  div.innerHTML = `
    <label>Job Title *</label><input type="text" name="job_title_${workCount}" required>
    <label>Company *</label><input type="text" name="company_${workCount}" required>
    <label>Location</label><input type="text" name="location_${workCount}">
    <label><input type="checkbox" name="current_${workCount}"> I currently work here</label>
    <div class="inline"><div><label>From</label><input type="date" name="from_${workCount}"></div><div><label>To</label><input type="date" name="to_${workCount}"></div></div>
    <label>Role Description</label><textarea name="role_desc_${workCount}" maxlength="1500"></textarea>
  `;
  wrap.appendChild(div);
}

function addEdu(){
  eduCount++; const wrap = document.getElementById('eduWrap');
  const div = document.createElement('div'); div.className='edu card'; div.dataset.index = eduCount; div.style.padding='12px'; div.style.marginBottom='10px';
  div.innerHTML = `
    <label>School / University *</label><input type="text" name="school_${eduCount}" required>
    <label>Degree *</label><input type="text" name="degree_${eduCount}" required>
    <label>Field of Study</label><input type="text" name="field_${eduCount}">
    <div class="inline"><div><label>From</label><input type="date" name="edu_from_${eduCount}"></div><div><label>To</label><input type="date" name="edu_to_${eduCount}"></div></div>
  `;
  wrap.appendChild(div);
}

function addCert(){
  certCount++; const wrap = document.getElementById('certWrap');
  const div = document.createElement('div'); div.className='cert card'; div.dataset.index = certCount; div.style.padding='12px'; div.style.marginBottom='10px';
  div.innerHTML = `
    <label>Certification Name</label><input type="text" name="cert_name_${certCount}">
    <label>Certification Number</label><input type="text" name="cert_no_${certCount}">
    <label>Issued Date</label><input type="date" name="cert_date_${certCount}">
    <label>Attachment</label><input type="file" name="cert_file_${certCount}">
  `;
  wrap.appendChild(div);
}

function addLang(){
  langCount++; const wrap = document.getElementById('langWrap');
  const div = document.createElement('div'); div.className='lang card'; div.dataset.index = langCount; div.style.padding='12px'; div.style.marginBottom='10px';
  div.innerHTML = `
    <label>Language *</label><select name="lang_${langCount}" required><option value="">--Select--</option><option>Lugbarati</option><option>Alur</option><option>Kakwa</option><option>Ma‚Äôdi</option><option>Luganda</option><option>English</option><option>Other</option></select>
    <label><input type="checkbox" name="fluent_${langCount}"> I am fluent</label>
    <label>Overall *</label><select name="level_${langCount}" required><option value="">--Select--</option><option>A1</option><option>A2</option><option>B1</option><option>B2</option><option>C1</option><option>C2</option><option>Mother Tongue</option></select>
  `;
  wrap.appendChild(div);
}

function addRef(){
  refCount++; const wrap = document.getElementById('refsWrap');
  const div = document.createElement('div'); div.className='ref card'; div.dataset.index = refCount; div.style.padding='12px'; div.style.marginBottom='10px';
  div.innerHTML = `
    <label>Reference Name *</label><input type="text" name="ref_name_${refCount}" required>
    <label>Organization / Address *</label><input type="text" name="ref_org_${refCount}" required>
    <label>Position *</label><input type="text" name="ref_position_${refCount}" required>
    <label>Relationship *</label><input type="text" name="ref_relationship_${refCount}" required>
    <label>Email *</label><input type="email" name="ref_email_${refCount}" required>
    <label>Telephone *</label><input type="tel" name="ref_phone_${refCount}" required>
    <label>Notes</label><textarea name="ref_notes_${refCount}"></textarea>
  `;
  wrap.appendChild(div);
}

/* ========== Save draft to localStorage ========== */
function saveDraft(){
  const data = {};
  const form = document.getElementById('careersForm');
  for(const el of form.elements){
    if(!el.name) continue;
    if(el.type === 'checkbox') data[el.name] = el.checked;
    else if(el.type !== 'file') data[el.name] = el.value;
  }
  localStorage.setItem('uncp_career_draft', JSON.stringify(data));
  alert('Draft saved locally in your browser.');
}
function loadDraftOnStart(){
  const raw = localStorage.getItem('uncp_career_draft');
  if(!raw) return;
  const data = JSON.parse(raw);
  const form = document.getElementById('careersForm');
  for(const k in data){
    if(form.elements[k]){
      const el = form.elements[k];
      if(el.type === 'checkbox') el.checked = data[k];
      else el.value = data[k];
    }
  }
}
window.addEventListener('load', loadDraftOnStart);

/* ========== Review & Submit flow ========== */
function reviewAndSubmit(){
  // Validate terms checkbox
  const agree = document.querySelector('input[name="agree_terms"]');
  if(agree && !agree.checked){ alert('Please agree to the terms and conditions.'); return; }

  // Generate simple review display and then call submit
  generatePDFandSubmit();
}

/* ========== Build PDF (jsPDF) from form and send to Apps Script + EmailJS ========= */
async function generatePDFandSubmit(){
  // Show submitting panel
  document.getElementById('submitInfo').style.display = 'block';
  document.getElementById('submitStatus').innerText = 'Building your application PDF...';

  // Collect form data as key/value pairs
  const formEl = document.getElementById('careersForm');
  const data = {};
  for(const el of formEl.elements){
    if(!el.name) continue;
    if(el.type === 'checkbox') data[el.name] = el.checked ? 'Yes' : 'No';
    else if(el.type === 'file') {
      // skip files in text summary (we upload separately if needed)
      data[el.name] = el.files && el.files.length ? el.files[0].name : '';
    }
    else data[el.name] = el.value || '';
  }

  // Create PDF text content (simple layout)
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'pt', format: 'a4' });
  let y = 40;
  doc.setFontSize(16); doc.text('UNCP Application', 40, y); y += 22;
  doc.setFontSize(11);
  doc.text(`Position: ${data.position_title || ''}`, 40, y); y += 18;
  doc.text(`Applicant: ${data.candidate_name || ''} ‚Äî ${data.candidate_email || ''}`, 40, y); y += 18;
  doc.text('---', 40, y); y += 14;

  // Loop fields and add to PDF (wrap text when needed)
  for(const k of Object.keys(data)){
    const label = k.replace(/_/g,' ');
    let value = String(data[k]);
    if(!value) continue;
    // add line, wrap if too long
    const maxWidth = 520;
    const lines = doc.splitTextToSize(`${label}: ${value}`, maxWidth);
    doc.text(lines, 40, y);
    y += (lines.length * 14) + 6;
    if(y > 730) { doc.addPage(); y = 40; }
  }

  // Optional: add timestamp
  doc.setFontSize(9); doc.text(`Generated: ${new Date().toLocaleString()}`, 40, 770);

  // Convert to base64
  const pdfBlob = doc.output('blob');
  const base64 = await blobToBase64(pdfBlob); // data:application/pdf;base64,xxx
  const base64str = base64.split(',')[1]; // strip mime prefix

  document.getElementById('submitStatus').innerText = 'Uploading PDF to Google Drive...';

  // POST to Apps Script
  try {
    const resp = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        token: APPS_SCRIPT_TOKEN,
        filename: `${(data.position_title || 'Application').replace(/\s+/g,'_')}_${(data.candidate_name||'candidate').replace(/\s+/g,'_')}.pdf`,
        contentBase64: base64str
      })
    });
    const result = await resp.json();
    if(!result.success){
      console.error('Apps Script error', result);
      alert('PDF upload failed: ' + (result.error || 'unknown'));
    } else {
      document.getElementById('submitStatus').innerText = 'PDF saved to Drive. Sending emails...';
      // Add Drive file link to data for email template
      data.application_pdf_url = result.fileUrl || '';
    }
  } catch(err){
    console.error('Upload failed', err);
    alert('Failed to upload PDF to Drive.');
  }

  // Send email via EmailJS to UNCP (full application)
  document.getElementById('submitStatus').innerText = 'Sending application to UNCP...';
  try {
    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_UNCP, data);
    console.log('Email to UNCP sent');
  } catch(e){
    console.error('EmailJS send to UNCP failed', e);
    alert('Failed to send application email to UNCP. Check EmailJS config.');
  }

  // Send confirmation email to candidate
  document.getElementById('submitStatus').innerText = 'Sending confirmation to applicant...';
  try {
    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_CANDIDATE, {
      candidate_name: data.candidate_name || '',
      candidate_email: data.candidate_email || '',
      position_title: data.position_title || ''
    });
    console.log('Confirmation email sent');
  } catch(e){
    console.error('EmailJS confirmation failed', e);
    alert('Failed to send confirmation to applicant.');
  }

  // Finalize
  document.getElementById('submitStatus').innerText = 'Done ‚Äî application submitted. You will receive confirmation by email.';
  // clear local draft and reset form
  localStorage.removeItem('uncp_career_draft');
  formEl.reset();
  goToStep(1);
}

/* helper: convert blob -> dataURL */
function blobToBase64(blob){
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = e => reject(e);
    reader.readAsDataURL(blob);
  });
}

/* Add keyboard escape to close JD */
document.addEventListener('keydown', (e) => { if(e.key === 'Escape') closeJD(); });

</script>
</body>
</html>
